# 🔍 攻撃ベクトル監査レポート

## ✅ 1. 攻撃ベクトル名とID

- **攻撃ベクトル:** `#7 - Bump Seed Canonicalization（PDAのBumpシード正規化）`

## ✅ 2. 概要（Description）

Solanaのプログラム派生アドレス(PDA)は種(seed)とバンプ(bump)で生成されます。特定のseedに対し、Solana runtimeは最大値のbumpを使ってPDAを一意に決定しますが、実は複数のbumpが有効となる場合があります。

もしプログラムが利用者から任意のbump値を受け取ってPDAを生成・確認していると、攻撃者は異なる有効なbumpを与えて本来とは別のアドレスを通してしまう可能性があります。つまり、「正規のPDA」ではないアドレスを巧妙にすり替えられる恐れがあります。

この監査では、プログラムがPDAを生成・検証する際に正規（canonical）なバンプシードを適切に使用しているかを確認します。

## ✅ 3. 監査対象コード箇所（Code Locations）

| No. | ファイル名     | 行番号     | 関数名・Accounts構造体名 |
|-----|----------------|------------|-------------------------|
| 1   | `programs/vulnerability-code/profile_manager.rs` | 19〜29行目 | `SetupProfile` |
| 2   | `programs/vulnerability-code/seed.rs` | 28〜38行目 | `InitializeAccount` |
| 3   | `programs/vulnerability-code/seed.rs` | 41〜48行目 | `UpdateAccount` |

## ✅ 4. コードレビュー結果（Code Review Result）

| チェック項目                                                | 結果（〇安全/×問題あり） |
|-------------------------------------------------------------|--------------------------|
| Anchor使用時の`#[account(seeds = [...], bump)]`の適切な使用 | × 問題あり               |
| ユーザー提供のバンプ値の検証                               | × 問題あり               |
| `create_program_address`の直接使用                          | 〇 安全（使用なし）      |
| バンプ値の保存と再利用                                      | × 問題あり               |

## ✅ 5. 危険なコードの抜粋（Insecure Code Snippet）

`programs/vulnerability-code/seed.rs`において、Bump Seed Canonicalizationに関する脆弱性が発見されました：

```rust
#[derive(Accounts)]
#[instruction(bump: u8)]
pub struct InitializeAccount<'info> {
    #[account(
        init, 
        seeds = [user.key().as_ref()], 
        bump = bump,  // ユーザー提供のbump値をそのまま使用（危険）
        payer = user, 
        space = 8 + 1 + 8
    )]
    pub user_data: Account<'info, UserData>,
    #[account(mut)]
    pub user: Signer<'info>,
    pub system_program: Program<'info, System>,
}

// 保存されたbump値を再利用（危険）
#[derive(Accounts)]
pub struct UpdateAccount<'info> {
    #[account(
        mut, 
        seeds = [user.key().as_ref()], 
        bump = user_data.bump  // 保存されたbump値を検証なしで使用
    )]
    pub user_data: Account<'info, UserData>,
    pub user: Signer<'info>,
}

#[account]
pub struct UserData {
    pub bump: u8,  // bumpを保存
    pub value: u64,
}
```

一方、`profile_manager.rs`では、Anchorの標準的なPDA生成方法を使用しており、安全です：

```rust
#[derive(Accounts)]
pub struct SetupProfile<'info> {
    #[account(
        init_if_needed,
        payer = user,
        space = 8 + 32 + 64,
        seeds = [b"profile", user.key().as_ref()],
        bump  // Anchorが自動的に正規のbumpを計算
    )]
    pub profile: Account<'info, Profile>,
    #[account(mut)]
    pub user: Signer<'info>,
    pub system_program: Program<'info, System>,
}
```

## ✅ 6. 影響度評価（Impact Assessment）

- **重要度:** High（高）
- **潜在的影響:** `seed.rs`の脆弱性により、攻撃者は非正規のバンプ値を使用してPDAを生成し、本来とは異なるアドレスを使用できる可能性があります。これにより、以下のような攻撃が可能になります：
  - 同じシードに対して複数の有効なPDAを作成し、プログラムの状態を混乱させる
  - 特定のPDAに関連付けられた権限や資産を不正に操作する
  - 正規のPDAと非正規のPDAを使い分けることで、プログラムの一貫性を破壊する

## ✅ 7. 推奨する修正方法（Recommended Fix）

`seed.rs`の脆弱性を修正するには、以下の変更が必要です：

1. ユーザー提供のバンプ値を使用せず、Anchorに正規のバンプを計算させる：

```rust
#[derive(Accounts)]
pub struct InitializeAccount<'info> {
    #[account(
        init, 
        seeds = [user.key().as_ref()], 
        bump,  // ユーザー提供のbumpを使わず、Anchorが自動計算
        payer = user, 
        space = 8 + 1 + 8
    )]
    pub user_data: Account<'info, UserData>,
    #[account(mut)]
    pub user: Signer<'info>,
    pub system_program: Program<'info, System>,
}
```

2. 初期化時に正規のバンプ値をアカウントに保存し、後続の操作でも同じ方法で検証する：

```rust
pub fn initialize_account(
    ctx: Context<InitializeAccount>, 
    initial_value: u64
) -> Result<()> {
    // 正規のバンプ値を保存（ctx.bumps.user_dataからアクセス可能）
    ctx.accounts.user_data.bump = ctx.bumps.user_data;
    ctx.accounts.user_data.value = initial_value;
    Ok(())
}

#[derive(Accounts)]
pub struct UpdateAccount<'info> {
    #[account(
        mut, 
        seeds = [user.key().as_ref()], 
        bump,  // 保存されたbump値を使わず、Anchorが自動計算
    )]
    pub user_data: Account<'info, UserData>,
    pub user: Signer<'info>,
}
```

`profile_manager.rs`については、現状のコードは安全であり、修正は必要ありません。ただし、以下の点に注意することを推奨します：

1. `init_if_needed`の使用について：
   - 現在のコードでは`init_if_needed`を使用していますが、これは既存アカウントの再初期化を許可する可能性があります。
   - 必要に応じて、アカウント内にis_initializedフラグを追加し、再初期化を明示的に防止することを検討してください。

## ✅ 8. 監査者コメント（Auditor's Comments）

- `seed.rs`では、ユーザー提供のバンプ値を直接使用し、それをアカウントに保存して後続の操作でも使用しています。これはBump Seed Canonicalizationの脆弱性を引き起こす典型的なパターンです。
- Anchorを使用する場合、`bump`属性を単独で使用すると、Anchorが自動的に正規のバンプ値を計算・検証します。`bump = xxx`のように明示的に値を指定すると、その値が使用され、正規性の検証が行われません。
- バンプ値をアカウントに保存すること自体は問題ありませんが、保存する値は必ず正規のバンプ値（`ctx.bumps.xxx`から取得）であるべきです。
- `profile_manager.rs`では、Anchorの標準的なPDA生成方法を使用しており、Bump Seed Canonicalizationに関する脆弱性はありません。

## ✅ 9. 再監査の推奨（Recommendation for Re-Audit）

- `seed.rs`の修正後、再監査を強く推奨します。

## ✅ 10. 監査チェックリストの記入（Audit Checklist Completion）

| チェック項目                                                | チェック結果（✓完了／×未完了） |
|-------------------------------------------------------------|--------------------------------|
| PDA生成コードで`find_program_address`を使用しているか確認   | ✓ 完了                         |
| `create_program_address`を直接使用していないか確認          | ✓ 完了（使用なし）             |
| ユーザー提供のbump値を直接信用せず再計算しているか確認      | × 未完了（`seed.rs`で問題あり） |
| Accounts構造体内で`seeds = [...], bump`が正しく記述されているか確認 | × 未完了（`seed.rs`で問題あり） |
| 保存したバンプ値の再利用時に再検証しているか確認           | × 未完了（`seed.rs`で問題あり） |
| 特殊なロジックでbump値検証をしている場合のコメント確認      | ✓ 完了                         |
