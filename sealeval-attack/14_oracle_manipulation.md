# オラクル操作（Oracle Manipulation）

## 概要

プログラムがPyth Networkなどの外部オラクルから価格データを取得している場合、攻撃者がオラクルの価格データの鮮度、遅延、信頼区間を悪用して不正な利益を得る可能性があります。

主な攻撃手法としては、以下のようなものがあります：

- **古い価格データ（Stale Price）の悪用**：
  攻撃者が意図的に過去の価格データを利用し、有利な取引を実行する。

- **遅延を利用したフロントランニング攻撃（Latency-based Attacks）**：
  オラクル更新の遅延を利用し、将来の価格を知りながら過去の価格を使用して有利なトランザクションを行う。

- **価格の不確実性（信頼区間）の悪用（Confidence Interval Exploits）**：
  価格の大きな変動や市場混乱時に、信頼区間の大きさを悪用してプロトコルを不利にする取引を行う。

- **先物価格の歪みの悪用（Futures Curve Manipulation）**：
  先物ベースで価格が決まる商品（原油、金利商品等）では、極端な市場環境で先物価格が歪むことがあり、これを悪用してプロトコルを攻撃する。

---

## 対処法（Pyth推奨のベストプラクティスより）

Pyth Networkが推奨するベストプラクティスに従い、以下のような対策を講じます：

1. **価格データの鮮度確認（Staleness Check）**
   - PythのSDKが提供する`getPriceNoOlderThan()`を使用して、一定時間より古い価格データを拒否する。
   - オラクル価格が最新のものかどうかを必ず確認し、古い価格で取引を許可しない。

2. **遅延への対応**
   - トランザクション実行時にリアルタイム価格を直接使用せず、決済に遅延を導入し、後で取得した確定価格を利用する仕組みを構築する。
   - ポジションを一定時間保有させるルールを設け、短期的な遅延悪用を防ぐ。

3. **信頼区間の積極的利用**
   - Pythが提供する信頼区間を積極的に利用し、担保評価では価格の下限（保守的価格）を採用し、借入評価やポジション清算時には価格の上限を採用してプロトコルを保護する。

4. **先物価格を利用する資産の適切な価格付け**
   - フロントマンス先物に価格が集中するリスクを軽減するため、複数の限月先物価格に分散したウェイト付けを行い、毎日再調整する。

---

## 危険なコード例

以下の例では、Pythから取得した価格データの鮮度や信頼区間を確認せずに使用しています：

```rust
// 危険なコード例：鮮度や信頼区間の検証がない
pub fn execute_trade(ctx: Context<ExecuteTrade>, amount: u64) -> Result<()> {
    let price_data = ctx.accounts.pyth_price_feed.get_price()?; // 鮮度や信頼区間を未検証
    let trade_value = amount * price_data.price;
    // 取引を実行
    Ok(())
}
```

---

## 安全なコード例（Pyth推奨ベストプラクティス準拠）

以下はPythのベストプラクティスに従い、価格データの鮮度チェックや信頼区間の検証を行う例です：

```rust
// 安全なコード例：鮮度および信頼区間の検証
pub fn execute_trade_secure(ctx: Context<ExecuteTradeSecure>, amount: u64) -> Result<()> {
    // 鮮度チェック：10秒以内の最新価格のみ許可
    let price_data = ctx.accounts.pyth_price_feed.get_price_no_older_than(10)
        .ok_or(ErrorCode::StaleOraclePrice)?;

    // 信頼区間の検証（信頼区間が価格の1%以内であることを確認）
    let confidence_ratio = (price_data.conf as f64) / (price_data.price as f64);
    require!(confidence_ratio <= 0.01, ErrorCode::ConfidenceIntervalTooWide);

    // 保守的価格を利用（担保評価の例）
    let conservative_price = price_data.price - price_data.conf;
    let trade_value = amount * conservative_price;

    // 取引を実行
    Ok(())
}
```

---

## 追加情報（Pyth推奨ベストプラクティスの詳細）

### 鮮度チェック（Staleness Check）の重要性
- Pyth SDKは標準で鮮度チェック機能を提供しており、古いデータの使用を防止します。
- デフォルト閾値を調整可能です（特に遅延に敏感なプロトコルは数秒単位に設定）。

### 信頼区間（Confidence Interval）の活用方法
- 市場が不安定な際、信頼区間が大きくなるため、信頼区間を価格評価に用いることでプロトコルを保護できます。
- 担保評価時に価格の下限を使い、借入評価時には価格の上限を利用します。

**例：価格が $50,000 ± $1,000 の場合**  
- 担保評価：$49,000を採用  
- 借入評価：$51,000を採用

### 遅延（Latency）対策
- オンチェーンオラクルではオフチェーンより遅延が必ず発生することを前提に、遅延を利用した攻撃に備える必要があります。
- デリバティブ取引では、遅延決済を導入し、即時決済を回避します。

### 先物価格の歪み（Futures-Based Pricing）への対応
- 原油など先物市場価格で決まる資産の価格付けでは、フロントマンス先物のウェイトを契約期限が近づくほど下げ、日々再調整を行うことで、市場の一時的な歪みを抑制します。

---

## ベストプラクティスまとめ（監査チェックポイント）

| チェック項目                  | チェック結果（✓完了／×未完了） |
|-------------------------------|---------------------------------|
| オラクル価格の鮮度チェックを実施       | ✓ 完了                        |
| 遅延攻撃への対応策を実装           | ✓ 完了                        |
| 信頼区間の検証および活用を実施      | ✓ 完了                        |
| 先物ベースの資産の価格付けを調整済み  | ✓ 完了                        |

---

## リスク評価基準（監査時の報告基準）

**重大な問題（Critical）として報告：**
- オラクル価格の鮮度を検証せずに取引を行う。
- 信頼区間を全く考慮しない価格評価を行っている。

**改善推奨（Medium）として報告：**
- 鮮度チェックの閾値が推奨より大幅に緩い。
- 価格評価に信頼区間を使っているが、許容範囲が広すぎてプロトコルの保護が不十分。
