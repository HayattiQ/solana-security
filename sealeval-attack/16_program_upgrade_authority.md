# プログラムアップグレード権限の不適切な管理

## 概要

Solanaのアップグレード可能なプログラムでは、アップグレード権限（upgrade authority）の管理が非常に重要です。

アップグレード権限が不適切に設定されている場合、悪意ある第三者がプログラムコードを差し替えることで、改ざんされたロジックや資金流出につながるリスクがあります。

## 対処法

1. プログラムをデプロイする際、アップグレード権限が必要な場合は信頼性の高い管理方法（例：マルチシグ）を採用する
2. 不要な場合は、アップグレード機能を無効化（権限をNoneに設定）して、プログラムの不変性を確保する
3. アップグレード時には徹底したコードレビューとセキュリティ監査を実施する

## 危険なケース

デフォルトのままアップグレード権限が広く設定されていると、誰でも後からアップグレード可能になり、予期せぬ変更が行われるリスクがあります。

## 推奨する対策

アップグレードが不要な場合、`bpf_loader_upgradeable`のアップグレード権限をNoneにします。必要な場合は、権限管理にマルチシグやオフライン署名などの対策を導入します。

```bash
# アップグレード権限を無効化する例
solana program set-upgrade-authority <PROGRAM_ID> --final
```

## 追加情報

### プログラムアップグレード権限の重要性

Solanaでは、プログラムのアップグレード権限を持つエンティティは、そのプログラムのコードを完全に置き換えることができます。これは非常に強力な権限であり、以下のようなリスクがあります：

1. **コード改ざんのリスク**
   - アップグレード権限を持つ者は、プログラムのロジックを任意に変更できます
   - 悪意ある変更により、ユーザー資産の盗難や不正な操作が可能になります

2. **単一障害点**
   - 単一のエンティティがアップグレード権限を持つ場合、そのエンティティが侵害されると全体が危険にさらされます
   - 秘密鍵の漏洩や内部不正により、プログラム全体が危険にさらされる可能性があります

3. **信頼モデルの変化**
   - アップグレード可能なプログラムは、本質的に「コードは法律」という原則から逸脱します
   - ユーザーは、プログラムのロジックだけでなく、アップグレード権限者も信頼する必要があります

### 安全なアップグレード権限管理の方法

1. **マルチシグの使用**

   複数の信頼できる関係者による署名を要求することで、単一障害点を排除します：

   ```bash
   # マルチシグウォレットをアップグレード権限者として設定
   solana program set-upgrade-authority <PROGRAM_ID> --new-upgrade-authority <MULTISIG_ADDRESS>
   ```

   Solanaでは、マルチシグの実装にSPL Governanceなどのプログラムを利用できます。

2. **タイムロックの導入**

   アップグレードの実行前に一定の遅延期間を設けることで、ユーザーに対応する時間を与えます：

   ```rust
   // アップグレード提案を作成し、タイムロックを設定
   propose_upgrade(program_id, buffer_address, delay_slots);
   
   // 遅延期間後にアップグレードを実行
   execute_upgrade(program_id, buffer_address);
   ```

3. **権限の完全な放棄**

   アップグレードが不要な場合、権限を完全に放棄することでプログラムを不変にします：

   ```bash
   # アップグレード権限を完全に放棄（--finalフラグ）
   solana program set-upgrade-authority <PROGRAM_ID> --final
   ```

4. **コールドストレージでの鍵管理**

   アップグレード権限の秘密鍵をオフラインで保管し、物理的に分離された環境でのみ使用します：

   ```bash
   # オフライン環境で署名を生成
   solana program deploy --keypair /path/to/offline/upgrade_authority.json /path/to/program.so
   ```

### アップグレードプロセスのベストプラクティス

1. **透明性の確保**
   - アップグレード計画を事前に公開し、コミュニティに通知する
   - 変更内容を明確に文書化し、理由を説明する

2. **コードレビューと監査**
   - アップグレード前に複数の独立した専門家によるコードレビューを実施する
   - 可能であれば、正式なセキュリティ監査を受ける

3. **テストネットでの検証**
   - メインネットへのデプロイ前に、テストネットで十分なテストを行う
   - エッジケースや後方互換性の問題を検証する

4. **緊急時の対応計画**
   - 脆弱性が発見された場合の緊急アップグレード手順を準備する
   - 責任ある開示ポリシーを確立する

プログラムアップグレード権限の適切な管理は、Solanaプロジェクトの長期的な安全性と信頼性にとって極めて重要です。特に資金を扱うプログラムでは、アップグレード権限の管理に細心の注意を払うべきです。


# 📝 監査手順書: プログラムアップグレード権限の管理不備

## 📌 監査目的

- Solanaプログラムのアップグレード権限（upgrade authority）が安全かつ適切に管理されているかを確認する。
- 悪意あるアップグレードを防止し、プロトコルの安全性を向上させるための推奨事項を提示する。

## 🔎 監査観点

- プログラムのアップグレード権限が適切な方法で設定されているか（マルチシグ、タイムロック、権限放棄など）
- アップグレード可能な場合、権限者が明確で信頼性が高いか
- アップグレード不要の場合、権限が明示的に放棄されているか

## 📋 監査手順詳細（チェックリスト）

### ✔️ Step 1: アップグレード権限の現状確認

- `[ ]` 対象のプログラムがアップグレード可能な状態かどうかを確認する
  ```bash
  solana program show <PROGRAM_ID>
  ```
- `[ ]` アップグレード権限（upgrade authority）が明確かつ信頼できる管理体制（マルチシグなど）に設定されているかを確認する
  ```bash
  solana program show <PROGRAM_ID> | grep "Upgrade authority"
  ```

### ✔️ Step 2: アップグレード権限管理体制の評価

- `[ ]` 権限が単一の秘密鍵に設定されている場合、セキュリティリスクが高いため改善を推奨する。
- `[ ]` マルチシグなど、複数の署名が必要な仕組みが導入されているかを確認する。
- `[ ]` アップグレードが不要な場合、権限を放棄（None）することを推奨する。

### ✔️ Step 3: 運用上の安全性推奨事項提示

- `[ ]` アップグレード時のコードレビュー・監査プロセスを文書化し、推奨する。
- `[ ]` アップグレード実施前の透明性確保（コミュニティへの事前通知、計画の公開）を推奨する。

**安全な運用例（権限放棄）:**
```bash
solana program set-upgrade-authority <PROGRAM_ID> --final
```

**安全な運用例（マルチシグ使用）:**
```bash
solana program set-upgrade-authority <PROGRAM_ID> --new-upgrade-authority <MULTISIG_ADDRESS>
```

## 📂 確認する対象（コード外の管理体制）

- プログラムデプロイ時の運用ドキュメント
- アップグレード権限管理の現状（実際にSolana CLIでの確認結果）
- プロジェクト運営チームの鍵管理ポリシーおよび責任体制

## 💬 監査中に確認する質問例

- 「現在のアップグレード権限者は誰か？」
- 「マルチシグやタイムロックなどのセキュリティ対策は導入されているか？」
- 「アップグレードが不要な場合、明確にアップグレード権限が放棄されているか？」

## 🚨 リスク評価基準

| リスクレベル | 説明（判断基準） |
| ------------ | ---------------------------------------------- |
| Critical（重大） | アップグレード権限が不明確で、第三者が自由に変更可能な状態の場合 |
| High（高） | 権限が単一の秘密鍵のみで管理されており、鍵漏洩時のリスクが高い場合 |
| Medium（中） | アップグレード可能な状態だが、管理方法（マルチシグなど）が一部不十分な場合 |
| Low（低） | 適切なマルチシグなど安全な権限管理が実施されているが、ドキュメントや透明性向上が推奨される場合 |
