# 外部依存ライブラリの脆弱性

## 概要

Solanaプログラムでは、外部のクレート（ライブラリ）に依存することが一般的です。しかし、これらのクレートに脆弱性が存在した場合、プログラム全体がその影響を受ける可能性があります。

特に、セキュリティ監査が十分でないライブラリを使用している場合、攻撃者に悪用されるリスクが増大します。

## 対処法

1. 信頼性が高く、広く利用されているクレートを選定する
2. 依存ライブラリのバージョン管理を厳格に行い、脆弱性情報を定期的に確認する
3. 必要に応じて、外部ライブラリのソースコードをレビューし、潜在的な脆弱性がないか確認する

## 危険なケース

脆弱な外部ライブラリに依存していると、ライブラリ内のバグやセキュリティホールを攻撃者に突かれ、プログラム全体の安全性が損なわれる可能性があります。

## 推奨する対策

1. 明示的にバージョンを固定し、セキュリティパッチが公開された場合は速やかにアップデートを行う
2. 依存ライブラリのセキュリティ監査レポートやコミュニティの評価を参考にする

```toml
# Cargo.tomlでの依存関係の例（バージョンを明示的に固定）
[dependencies]
solana-program = "=1.16.0"
anchor-lang = "=0.28.0"
```

## 追加情報

### 依存ライブラリのリスク

外部依存ライブラリは、開発効率を高める一方で、以下のようなセキュリティリスクをもたらす可能性があります：

1. **既知の脆弱性**
   - 公開されている脆弱性が修正されていないライブラリを使用すると、攻撃者に悪用される可能性があります
   - 特に、セキュリティ更新が頻繁に行われていないライブラリは危険です

2. **サプライチェーン攻撃**
   - 依存ライブラリのメンテナが悪意を持って、または侵害されて悪意のあるコードを挿入する可能性があります
   - 人気のあるライブラリほど、攻撃者の標的になりやすいです

3. **未発見の脆弱性**
   - 監査されていないライブラリには、未発見の脆弱性が潜んでいる可能性があります
   - 特に複雑なロジックや暗号実装を含むライブラリは注意が必要です

### 安全な依存関係管理のベストプラクティス

1. **依存関係の最小化**

   必要最小限のライブラリのみを使用し、依存関係のグラフを単純に保ちます：

   ```toml
   # 必要なクレートのみを依存関係に含める
   [dependencies]
   solana-program = "=1.16.0"
   # 本当に必要なクレートのみを追加
   ```

2. **バージョン固定と更新管理**

   依存関係のバージョンを明示的に固定し、計画的に更新します：

   ```toml
   # バージョンを明示的に固定
   [dependencies]
   solana-program = "=1.16.0"  # 完全に固定
   anchor-lang = "~0.28.0"     # パッチバージョンのみ更新許可
   ```

   また、依存関係の更新を定期的にチェックするツールを導入します：

   ```bash
   # cargo-audit を使用して脆弱性をチェック
   cargo install cargo-audit
   cargo audit
   ```

3. **ベンダリングの検討**

   特に重要なライブラリについては、ベンダリング（依存コードをプロジェクト内に取り込む）を検討します：

   ```bash
   # 依存ライブラリのソースコードをプロジェクト内にコピー
   mkdir -p vendor/important-lib
   cp -r ~/.cargo/registry/src/github.com-*/important-lib-0.1.0/* vendor/important-lib/
   
   # Cargo.tomlで参照
   [dependencies]
   important-lib = { path = "vendor/important-lib" }
   ```

4. **監査済みライブラリの優先**

   可能な限り、セキュリティ監査を受けたライブラリを選択します：

   - Anchor Framework: Solanaエコシステムで広く使用され、複数の監査を受けています
   - SPL (Solana Program Library): Solana Labsによって維持され、広く使用されています
   - secp256k1: 暗号ライブラリとして広く監査されています

### 依存ライブラリの評価基準

新しいライブラリを採用する前に、以下の点を評価することをお勧めします：

1. **コミュニティの活発さ**
   - GitHubのスター数、コントリビューター数、最新のコミット日
   - 未解決のIssueやPull Requestの数と質

2. **セキュリティ履歴**
   - 過去のセキュリティ脆弱性とその対応
   - セキュリティ監査の有無と結果

3. **コード品質**
   - テストカバレッジ
   - コードレビュープロセス
   - ドキュメントの質

4. **メンテナンスの状況**
   - リリース頻度
   - Issue対応の速さ
   - セキュリティパッチの迅速さ

外部依存ライブラリの脆弱性は、Solanaプログラムのセキュリティにおいて見落とされがちな要素です。特に資金を扱うプログラムでは、依存関係の選択と管理に細心の注意を払うべきです。定期的な監査と更新を行い、潜在的なリスクを最小限に抑えましょう。


# 📝 監査手順書: Immutable Data Bypass（不変データのバイパス攻撃）

## 📌 監査目的
- 初期化時に設定された後、変更されるべきではない不変データ（Immutable Data）が適切に保護されているか確認する。
- 不変データが攻撃者により意図せず変更される可能性がないことを保証する。

## 🔎 監査観点
監査において以下の項目を確認する。

- 不変データが明確に定義され、適切に設計されていること
- 不変データへの更新が初期化後に禁止されていること
- Anchorの制約機能やロジックチェックにより不変データが確実に保護されていること

## 📋 監査手順詳細（チェックリスト）

### ✔️ Step 1: 不変データの特定
- `[ ]` プログラムのアカウント構造体内で不変として設計されているフィールドを特定する。
- `[ ]` 初期化時以降、これらのフィールドを変更するようなコードが存在しないか確認する。

### ✔️ Step 2: 初期化時の不変データ設定の妥当性確認
- `[ ]` 初期化関数（initialize関数等）で不変データが適切に設定されているか確認する。
- `[ ]` 初期化処理時に「既に初期化済みかどうか」を示すフラグ（例：`is_initialized`）などが導入されているか確認する。

**安全な例：**
```rust
pub fn initialize(ctx: Context<Initialize>, admin: Pubkey) -> Result<()> {
    require!(!ctx.accounts.config.is_initialized, AlreadyInitialized);
    ctx.accounts.config.is_initialized = true;
    ctx.accounts.config.admin = admin;
    Ok(())
}
```

### ✔️ Step 3: 不変データ保護のロジック確認
- `[ ]` 不変データが後続処理により変更されることを防ぐロジックが存在することを確認する。
- `[ ]` Anchorの`constraint`属性やカスタムロジックで不変データの保護が適切に行われていることを確認する。

**安全な例：**
```rust
#[derive(Accounts)]
pub struct UpdateConfig<'info> {
    #[account(
        mut,
        constraint = config.admin == admin.key() @ Unauthorized,
        constraint = config.fee_rate_locked @ FeeRateLocked
    )]
    pub config: Account<'info, Config>,
    pub admin: Signer<'info>,
}
```

## 📂 確認するコード箇所（具体的な確認対象）
- 初期化関数（initialize関数）および関連Accounts構造体
- 不変データを含むアカウントの構造体定義箇所
- 設定変更関数（update関数）等、不変データを変更する可能性のあるすべてのコード箇所

## 💬 監査中に確認する質問例
- 「このデータは初期化後に変更されるべきものか？」
- 「不変データがAnchorの制約やフラグによって十分に保護されているか？」
- 「初期化処理以外に不変データが変更される経路が存在してしまっていないか？」

## 🚨 リスク評価基準
以下の基準に従いリスクを評価する。

| リスクレベル | 説明（判断基準） |
| ------------ | ---------------------------------------------- |
| Critical（重大） | 不変データが初期化後に自由に変更可能であり、かつそれを防ぐロジックが存在しない場合 |
| High（高） | 不変データへの変更を許す脆弱なロジックが存在し、一部の状況で悪用される可能性がある場合 |
| Medium（中） | Anchorの制約など追加的な保護策がなく、不変データが将来的に変更される可能性がある場合 |
| Low（低） | ロジック的に変更不能であるが、コードの明確性や可読性を改善するための追加措置が推奨される場合 |

以上をもとに監査を実施し、不変データバイパス攻撃に対する保護が十分であるかを評価してください。